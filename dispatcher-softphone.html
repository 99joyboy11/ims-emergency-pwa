<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IMS Dispatcher Softphone</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/sip.js/dist/sip.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#0f0f0f;
color:white;
text-align:center;
}

.header{
padding:20px;
background:#222;
}

#map{
height:500px;
width:100%;
}

button{
padding:12px 25px;
font-size:16px;
margin:10px;
cursor:pointer;
}

#status{
color:#00ff00;
font-size:18px;
}

</style>

</head>

<body>

<div class="header">
<h2>Dispatcher Console</h2>
<div id="status">Connecting to PBX...</div>

<button onclick="answerCall()">Answer Call</button>
<button onclick="hangupCall()">Hangup</button>

</div>

<div id="map"></div>

<script>

/****************************************************
 YEASTAR PBX CONFIG â­ CHANGE THIS
****************************************************/

const pbxDomain = "https://microbizone.sgycm.yeastarcloud.com";
const extensionCallerID = "102";

const registrationName = "zoyOlw23Hf";
const registrationPassword = "blDoqkpQl2";

const wsServer =
`wss://${pbxDomain}:8089/ws`;

/****************************************************
 MAP
****************************************************/

const map = L.map("map")
.setView([14.5995,120.9842],12);

L.tileLayer(
"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
).addTo(map);

let marker = null;

/****************************************************
 SIP WEBRTC REGISTRATION
****************************************************/

let session = null;

const userAgent = new SIP.UserAgent({

uri: SIP.UserAgent.makeURI(
`sip:${registrationName}@${pbxDomain}`
),

displayName: extensionCallerID,

transportOptions:{
server: wsServer
},

authorizationUsername: registrationName,
authorizationPassword: registrationPassword,

sessionDescriptionHandlerFactoryOptions:{
constraints:{
audio:true,
video:false
}
}

});

/****************************************************
 START REGISTRATION
****************************************************/

userAgent.start().then(()=>{

document.getElementById("status").innerText =
"Registered as Extension 102 âœ…";

});

/****************************************************
 INCOMING CALL HANDLER
****************************************************/

userAgent.delegate = {

onInvite(invitation){

console.log("Incoming Call");

session = invitation;

document.getElementById("status").innerText =
"Incoming Call ðŸ””";

showCallerLocation();

}

};

/****************************************************
 CALL CONTROL
****************************************************/

function answerCall(){

if(!session){
alert("No incoming call");
return;
}

session.accept();

document.getElementById("status").innerText =
"Call Connected ðŸŽ§";

}

function hangupCall(){

if(session){
session.terminate();
}

}

/****************************************************
 CALLER LOCATION FROM IMS SIMULATION
****************************************************/

function showCallerLocation(){

const call =
JSON.parse(localStorage.getItem("activeCall"));

if(!call) return;

if(marker){
marker.setLatLng([call.lat, call.lng]);
}else{

marker = L.marker([
call.lat,
call.lng
]).addTo(map)
.bindPopup("Caller Location");

map.setView([call.lat, call.lng],16);

}

}

setInterval(showCallerLocation,2000);

</script>

</body>
</html>
