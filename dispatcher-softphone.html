<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Emergency Dispatch Console</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/sip.js/dist/sip.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#0b0b0b;
color:white;
}

.header{
padding:20px;
background:#222;
text-align:center;
}

#map{
height:500px;
}

.console{
padding:20px;
text-align:center;
}

button{
padding:12px 30px;
font-size:16px;
margin:10px;
cursor:pointer;
}

#status{
color:#00ff00;
font-size:20px;
}

</style>

</head>

<body>

<div class="header">
<h2>Emergency Dispatch Control Room</h2>
<div id="status">Connecting to PBX...</div>

<button onclick="answerCall()">Answer Call</button>
<button onclick="hangupCall()">Hangup</button>

</div>

<div id="map"></div>

<script>

/*********************************************
 YEASTAR PBX CONFIG â­ CHANGE ONLY THESE
*********************************************/

const pbxDomain =
"microbizone.sgycm.yeastarcloud.com";

const extensionCallerID = "102";

const registrationName = "zoyOlw23Hf";
const registrationPassword = "blDoqkpQl2";

const wsServer =
`wss://${pbxDomain}:8089/ws`;

/*********************************************
 MAP INIT
*********************************************/

const map = L.map("map")
.setView([14.5995,120.9842],12);

L.tileLayer(
"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
).addTo(map);

let marker = null;

/*********************************************
 SIP WEBRTC CLIENT
*********************************************/

let session = null;

const userAgent = new SIP.UserAgent({

uri: SIP.UserAgent.makeURI(
`sip:${registrationName}@${pbxDomain}`
),

displayName: extensionCallerID,

transportOptions:{
server: wsServer
},

authorizationUsername: registrationName,
authorizationPassword: registrationPassword,

sessionDescriptionHandlerFactoryOptions:{
constraints:{
audio:true,
video:false
}
}

});

/*********************************************
 REGISTER TO PBX
*********************************************/

userAgent.start().then(()=>{

document.getElementById("status").innerText =
"Registered to PBX âœ…";

});

/*********************************************
 INCOMING CALL HANDLER
*********************************************/

userAgent.delegate = {

onInvite(invitation){

session = invitation;

document.getElementById("status").innerText =
"Incoming Emergency Call ðŸ””";

showCallerLocation();

}

};

/*********************************************
 CALL CONTROLS
*********************************************/

function answerCall(){

if(session){
session.accept();
}

}

function hangupCall(){

if(session){
session.terminate();
}

}

/*********************************************
 SHOW CALLER LOCATION
*********************************************/

function showCallerLocation(){

const call =
JSON.parse(localStorage.getItem("activeCall"));

if(!call) return;

if(marker){

marker.setLatLng([call.lat, call.lng]);

}else{

marker = L.marker([
call.lat,
call.lng
]).addTo(map)
.bindPopup("Emergency Caller Location");

map.setView([call.lat, call.lng],16);

}

}

setInterval(showCallerLocation,2000);

</script>

</body>
</html>
