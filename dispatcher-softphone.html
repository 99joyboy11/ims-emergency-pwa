<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IMS Dispatcher Control Room</title>

<script src="https://unpkg.com/sip.js/dist/sip.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#111;
color:white;
text-align:center;
}

#map{
height:500px;
width:100%;
}

.toolbar{
padding:15px;
background:#222;
}

button{
padding:12px 25px;
font-size:16px;
margin:8px;
cursor:pointer;
}

#status{
color:#0f0;
margin:15px;
font-size:18px;
}

</style>

</head>

<body>

<div class="toolbar">
<h2>Dispatcher Control Room</h2>
<div id="status">Not Registered</div>

<button onclick="answerCall()">Answer Call</button>
<button onclick="hangupCall()">Hangup</button>
</div>

<div id="map"></div>

<script>

////////////////////////////////////////////////////
// CONFIG (CHANGE THIS â­â­â­â­â­)
////////////////////////////////////////////////////

const extension = "1001";
const password = "YOUR_EXTENSION_PASSWORD";
const pbxDomain = "YOUR_PBX_DOMAIN.yeastarcloud.com";

const wsServer =
`wss://${pbxDomain}:8089/ws`;

////////////////////////////////////////////////////
// MAP SETUP
////////////////////////////////////////////////////

const map = L.map("map").setView(
[14.5995,120.9842], 12
);

L.tileLayer(
"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
).addTo(map);

let marker = null;

////////////////////////////////////////////////////
// PBX WEBSOCKET SIP CLIENT
////////////////////////////////////////////////////

let session = null;

const userAgent = new SIP.UserAgent({

uri: SIP.UserAgent.makeURI(
`sip:${extension}@${pbxDomain}`
),

transportOptions:{
server: wsServer
},

authorizationUsername: extension,
authorizationPassword: password,

sessionDescriptionHandlerFactoryOptions:{
constraints:{
audio:true,
video:false
}
}

});

////////////////////////////////////////////////////
// REGISTER TO PBX
////////////////////////////////////////////////////

userAgent.start().then(()=>{

document.getElementById("status").innerText =
"Registered to PBX âœ…";

});

////////////////////////////////////////////////////
// INCOMING CALL DETECTION
////////////////////////////////////////////////////

userAgent.delegate = {

onInvite(invitation){

session = invitation;

document.getElementById("status").innerText =
"Incoming Call ðŸ””";

showCallerLocation();

}

};

////////////////////////////////////////////////////
// CALL CONTROL
////////////////////////////////////////////////////

function answerCall(){

if(!session){
alert("No incoming call");
return;
}

session.accept();

document.getElementById("status").innerText =
"Call Connected ðŸŽ§";

}

function hangupCall(){

if(session){
session.terminate();
}

}

////////////////////////////////////////////////////
// LOCATION DISPLAY (FROM CITIZEN APP)
////////////////////////////////////////////////////

function showCallerLocation(){

const call =
JSON.parse(localStorage.getItem("activeCall"));

if(!call) return;

if(marker){
marker.setLatLng([call.lat, call.lng]);
}else{

marker = L.marker([
call.lat,
call.lng
]).addTo(map)
.bindPopup("Caller Location")
.openPopup();

}

map.setView([call.lat, call.lng],16);

}

////////////////////////////////////////////////////

setInterval(showCallerLocation,2000);

</script>

</body>
</html>
